name: OdinPack Builder

on:
  workflow_dispatch:
    inputs:
      DEVICE_CODES:
        type: string
        required: true
      RECOVERY_URL:
        type: string
        required: true
      VBMETA_URL:
        type: string
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:

      - name: Make workspace
        run: mkdir work

      - name: Download recovery + vbmeta
        run: |
          cd work
          wget -O recovery_file "${{ github.event.inputs.RECOVERY_URL }}"
          wget -O vbmeta_file "${{ github.event.inputs.VBMETA_URL }}"

      - name: Process recovery
        run: |
          cd work
          # If recovery URL ends in .tar, extract it
          if [[ "${{ github.event.inputs.RECOVERY_URL }}" == *.tar ]]; then
            mkdir rec
            tar -xf recovery_file -C rec || true
            # Find any .img inside
            REC=$(find rec -type f -name "*.img" | head -n1)
            cp "$REC" recovery.img
          else
            cp recovery_file recovery.img
          fi

      - name: Process vbmeta
        run: |
          cd work
          if [[ "${{ github.event.inputs.VBMETA_URL }}" == *.tar ]]; then
            mkdir vbm
            tar -xf vbmeta_file -C vbm || true
            VBM=$(find vbm -type f -name "*.img" | head -n1)
            cp "$VBM" vbmeta.img
          else
            cp vbmeta_file vbmeta.img
          fi

      - name: Build naming
        id: names
        run: |
          RAW="${{ github.event.inputs.DEVICE_CODES }}"
          CLEAN=$(echo "$RAW" | tr -d ' ' | tr ',' '-')
          DATE=$(date +%Y%m%d)
          TAR="ArtisanROM-${CLEAN}-${DATE}.tar"

          echo "tarfile=$TAR" >> $GITHUB_OUTPUT
          echo "raw=$RAW" >> $GITHUB_OUTPUT
          echo "clean=$CLEAN" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT

      - name: Create final tar
        run: |
          cd work
          tar -cf "${{ steps.names.outputs.tarfile }}" recovery.img vbmeta.img

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "artisanrom-${{ steps.names.outputs.clean }}-${{ steps.names.outputs.date }}"
          name: "ArtisanROM Build ${{ steps.names.outputs.date }}"
          body: |
            Devices:
            ${{ steps.names.outputs.raw }}
          files: work/${{ steps.names.outputs.tarfile }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
