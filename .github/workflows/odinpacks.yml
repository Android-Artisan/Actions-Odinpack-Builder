name: OdinPack Builder

on:
  workflow_dispatch:
    inputs:
      DEVICE_CODES:
        type: string
        required: true
      RECOVERY_URL:
        type: string
        required: true
      VBMETA_URL:
        type: string
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v4

      - name: Download files
        run: |
          wget -O recovery_file "${{ github.event.inputs.RECOVERY_URL }}"
          wget -O vbmeta_file "${{ github.event.inputs.VBMETA_URL }}"

      - name: Process recovery
        run: |
          # If the URL ends with .tar, extract it
          if [[ "${{ github.event.inputs.RECOVERY_URL }}" == *.tar ]]; then
            tar -xf recovery_file || true
            REC=$(find . -maxdepth 1 -type f -name "*.img" | head -n1)
            cp "$REC" recovery.img
          else
            cp recovery_file recovery.img
          fi

      - name: Process vbmeta
        run: |
          if [[ "${{ github.event.inputs.VBMETA_URL }}" == *.tar ]]; then
            tar -xf vbmeta_file || true
            VBM=$(find . -maxdepth 1 -type f -name "*.img" ! -name "recovery.img" | head -n1)
            cp "$VBM" vbmeta.img
          else
            cp vbmeta_file vbmeta.img
          fi

      - name: Generate names
        id: names
        run: |
          RAW="${{ github.event.inputs.DEVICE_CODES }}"
          CLEAN=$(echo "$RAW" | tr -d ' ' | tr ',' '-')
          DATE=$(date +%Y%m%d)
          TAR="ArtisanROM-${CLEAN}-${DATE}.tar"

          echo "tarfile=$TAR" >> $GITHUB_OUTPUT
          echo "raw=$RAW" >> $GITHUB_OUTPUT
          echo "clean=$CLEAN" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT

      - name: Create final tar
        run: |
          tar -cf "${{ steps.names.outputs.tarfile }}" recovery.img vbmeta.img

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "artisanrom-${{ steps.names.outputs.clean }}-${{ steps.names.outputs.date }}"
          name: "ArtisanROM Build ${{ steps.names.outputs.date }}"
          body: |
            Devices:
            ${{ steps.names.outputs.raw }}
          files: ${{ steps.names.outputs.tarfile }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
