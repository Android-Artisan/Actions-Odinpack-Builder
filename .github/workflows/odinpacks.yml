name: OdinPack Builder

on:
  workflow_dispatch:
    inputs:
      DEVICE_CODES:
        description: "Device codes (comma-separated)"
        type: string
        required: true
      RECOVERY_URL:
        description: "Link to recovery.img or tar"
        type: string
        required: true
      VBMETA_URL:
        description: "Link to vbmeta.img or tar"
        type: string
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v4

      - name: Prep
        run: mkdir work

      - name: Download files
        run: |
          cd work
          wget -O recovery_download "${{ github.event.inputs.RECOVERY_URL }}"
          wget -O vbmeta_download "${{ github.event.inputs.VBMETA_URL }}"

      - name: Extract recovery
        run: |
          cd work
          if tar -tf recovery_download > /dev/null 2>&1; then
            tar -xf recovery_download
            REC=$(find . -type f ! -name "*vbmeta*" | head -n1)
            cp "$REC" recovery.img
          else
            cp recovery_download recovery.img
          fi

      - name: Extract vbmeta
        run: |
          cd work
          if tar -tf vbmeta_download > /dev/null 2>&1; then
            tar -xf vbmeta_download
            VBM=$(find . -type f ! -name "*recovery*" | head -n1)
            cp "$VBM" vbmeta.img
          else
            cp vbmeta_download vbmeta.img
          fi

      - name: Generate names
        id: namegen
        run: |
          DEVCODES="${{ github.event.inputs.DEVICE_CODES }}"
          DEVCODES_CLEAN=$(echo "$DEVCODES" | tr -d ' ' | tr ',' '-')
          DATE=$(date +%Y%m%d)
          TARFILE="ArtisanROM-${DEVCODES_CLEAN}-${DATE}.tar"

          echo "TARFILE=$TARFILE" >> $GITHUB_OUTPUT
          echo "DATE=$DATE" >> $GITHUB_OUTPUT
          echo "DEVCODES_CLEAN=$DEVCODES_CLEAN" >> $GITHUB_OUTPUT
          echo "DEVCODES_RAW=${{ github.event.inputs.DEVICE_CODES }}" >> $GITHUB_OUTPUT

      - name: Create OdinPack
        run: |
          cd work
          tar -cf "${{ steps.namegen.outputs.TARFILE }}" recovery.img vbmeta.img

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "artisanrom-${{ steps.namegen.outputs.DATE }}-${{ steps.namegen.outputs.DEVCODES_CLEAN }}"
          name: "ArtisanROM Build - ${{ steps.namegen.outputs.DATE }}"
          body: |
            Devices:
            ${{ steps.namegen.outputs.DEVCODES_RAW }}
          files: work/${{ steps.namegen.outputs.TARFILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
